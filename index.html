<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanFlow: Swipe to Joy</title>
  <meta name="description" content="Swipe cleaning tasks. No progress bar. Just joy, confetti, and done." />
  <link rel="canonical" href="https://cleanflow.vercel.app" />
  <meta property="og:title" content="CleanFlow â€“ Swipe & Celebrate" />
  <meta property="og:description" content="No pressure. Just swipe. Just joy." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --primary: #4f46e5;
      --success: #10b981;
      --gold: #fbbf24;
      --bg: #f8fafc;
      --card: white;
      --text: #1e293b;
      --gray: #94a3b8;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 1rem;
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .container { max-width: 480px; margin: 0 auto; }
    h1 { font-size: 1.8rem; text-align: center; margin-bottom: 1rem; color: var(--primary); }
    .room-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .room-btn {
      background: var(--card);
      border: 2px solid #e2e8f0;
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .room-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
    .room-btn:active { transform: scale(0.98); }

    .task-list { display: none; }
    .task-list.active { display: block; animation: fadeIn 0.4s; }

    .task-tile {
      background: var(--card);
      border-radius: 1rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: grab;
      user-select: none;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      transform: translateX(0);
    }
    .task-tile:active { cursor: grabbing; }
    .task-tile.done {
      opacity: 0.7;
      text-decoration: line-through;
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border-left: 6px solid var(--success);
    }
    .task-priority {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    .task-text { font-size: 1rem; }

    .hurray-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: var(--gold);
      color: white;
      padding: 1.5rem 2rem;
      border-radius: 2rem;
      font-weight: 700;
      font-size: 1.8rem;
      z-index: 1000;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      animation: pop 0.6s forwards;
    }
    @keyframes pop {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      background: #f59e0b;
      animation: fall 1.2s linear forwards;
      pointer-events: none;
    }
    @keyframes fall {
      to { transform: translateY(120vh) rotate(720deg); opacity: 0; }
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 1rem;
      cursor: pointer;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--gray);
    }
    .share-url {
      font-size: 0.8rem;
      color: var(--gray);
      word-break: break-all;
      margin-top: 1rem;
      padding: 0.5rem;
      background: #f1f5f9;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CleanFlow</h1>
    <p style="text-align:center; color:var(--gray); margin-bottom:1.5rem;">
      Pick a room. Swipe to finish. Feel the joy.
    </p>

    <!-- Room Selection -->
    <div id="roomSelection" class="room-grid">
      <div class="room-btn" data-room="Kitchen">Kitchen</div>
      <div class="room-btn" data-room="Bathroom">Bathroom</div>
      <div class="room-btn" data-room="Living Room">Living Room</div>
      <div class="room-btn" data-room="Bedroom">Bedroom</div>
    </div>

    <!-- Task View -->
    <div id="taskView" style="display:none;">
      <div class="back-btn" id="backToRooms">
        <i class="fas fa-arrow-left"></i> Change Room
      </div>
      <h2 id="roomTitle"></h2>
      <div id="taskList"></div>
      <div class="share-url" id="shareUrl"></div>
    </div>

    <div id="loading" class="loading" style="display:none;">
      <i class="fas fa-spinner fa-spin"></i> Asking Grok for smart tasks...
    </div>
  </div>

  <!-- Hurray Popup -->
  <div id="hurray" class="hurray-popup" style="display:none;">HURRAY!</div>

  <script>
    // === GROK KEY (Injected via Build Command) ===
    const GROK_API_KEY = 'YOUR_GROK_API_KEY_HERE'; // Replaced at build with env var

    if (!GROK_API_KEY || GROK_API_KEY === 'YOUR_GROK_API_KEY_HERE') {
      alert('Error: GROK_API_KEY not set. Check Vercel Build Command & Env Vars.');
      // Fallback to static tasks
      window.fetchTasks = function(room) {
        const fallbacks = {
          Kitchen: [`Wipe counters`, `Sweep floor`, `Take out trash`, `Clean sink`, `Organize cabinets`],
          Bathroom: [`Scrub toilet`, `Clean mirror`, `Wipe sink`, `Mop floor`, `Restock towels`],
          'Living Room': [`Dust surfaces`, `Vacuum carpet`, `Tidy cushions`, `Wipe TV`, `Organize remotes`],
          Bedroom: [`Make bed`, `Fold clothes`, `Dust nightstand`, `Vacuum floor`, `Organize closet`]
        };
        tasks = fallbacks[room] || [`Wipe surfaces`, `Sweep floor`, `Take trash`, `Clean mirrors`, `Organize items`];
        loading.style.display = 'none';
        renderTasks();
      };
    }

    const ENCRYPT_KEY = 'cleanflow-secret-2025';

    // === STATE ===
    let currentRoom = '';
    let tasks = [];
    let completed = new Set();

    // === ELEMENTS ===
    const roomSelection = document.getElementById('roomSelection');
    const taskView = document.getElementById('taskView');
    const roomTitle = document.getElementById('roomTitle');
    const taskList = document.getElementById('taskList');
    const loading = document.getElementById('loading');
    const shareUrl = document.getElementById('shareUrl');
    const backToRooms = document.getElementById('backToRooms');
    const hurray = document.getElementById('hurray');

    // === URL ENCRYPTION ===
    function encrypt(data) {
      return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPT_KEY).toString();
    }
    function decrypt(hash) {
      try {
        const bytes = CryptoJS.AES.decrypt(hash, ENCRYPT_KEY);
        return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
      } catch { return null; }
    }

    // === UPDATE URL ===
    function updateURL() {
      const state = { room: currentRoom, done: Array.from(completed) };
      const encrypted = encrypt(state);
      const url = new URL(window.location);
      url.hash = encrypted;
      window.history.replaceState(null, '', url);
      shareUrl.textContent = `Share: ${url.toString().slice(0, 60)}...`;
    }

    // === RENDER TASKS ===
    function renderTasks() {
      taskList.innerHTML = '';
      tasks.forEach((task, i) => {
        const tile = document.createElement('div');
        tile.className = `task-tile ${completed.has(i) ? 'done' : ''}`;
        tile.innerHTML = `
          <div class="task-priority">Priority ${i + 1}</div>
          <div class="task-text">${task}</div>
        `;
        if (!completed.has(i)) {
          let startX;
          const onStart = (e) => startX = e.touches ? e.touches[0].clientX : e.clientX;
          const onMove = (e) => {
            if (!startX) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const diff = x - startX;
            if (diff > 120) {
              completeTask(i, tile);
            } else {
              tile.style.transform = `translateX(${diff}px) rotate(${diff/10}deg)`;
            }
          };
          const onEnd = () => {
            tile.style.transform = '';
            startX = undefined;
          };

          tile.addEventListener('touchstart', onStart);
          tile.addEventListener('touchmove', onMove);
          tile.addEventListener('touchend', onEnd);
          tile.addEventListener('mousedown', onStart);
          tile.addEventListener('mousemove', onMove);
          tile.addEventListener('mouseup', onEnd);
          tile.addEventListener('mouseleave', onEnd);
        }
        taskList.appendChild(tile);

        if (!completed.has(i) && completed.size > 0) {
          setTimeout(() => tile.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
        }
      });
    }

    // === EMOTIONAL SPIKE ===
    function completeTask(index, tile) {
      if (completed.has(index)) return;
      completed.add(index);
      tile.classList.add('done');
      updateURL();
      renderTasks();

      hurray.style.display = 'block';
      setTimeout(() => hurray.style.display = 'none', 800);

      for (let i = 0; i < 40; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + 'vw';
        c.style.background = ['#f59e0b','#10b981','#3b82f6','#ef4444','#8b5cf6'][Math.floor(Math.random()*5)];
        c.style.animationDelay = Math.random() * 0.3 + 's';
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 1500);
      }

      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwF');
      audio.play().catch(() => {});

      if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

      tile.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
      setTimeout(() => {
        tile.style.background = 'linear-gradient(135deg, #ecfdf5, #d1fae5)';
      }, 400);
    }

    // === FETCH TASKS FROM GROK ===
    async function fetchTasks(room) {
      loading.style.display = 'block';
      taskList.innerHTML = '<p style="text-align:center;color:var(--gray);">Loading tasks...</p>';

      try {
        const res = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${GROK_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'grok-beta',
            messages: [{
              role: 'user',
              content: `Give me 5 short, priority-ordered cleaning tasks for the ${room}. 2 sentences max. Number them 1-5.`
            }],
            max_tokens: 150
          })
        });

        if (!res.ok) throw new Error('API error');

        const data = await res.json();
        const text = data.choices[0].message.content;
        tasks = text.split('\n')
          .filter(line => /^\d+\./.test(line))
          .map(line => line.replace(/^\d+\.\s*/, '').trim())
          .slice(0, 5);

        if (tasks.length === 0) throw new Error('No tasks');

      } catch (e) {
        console.warn('Grok failed, using fallback');
        const fallbacks = {
          Kitchen: [`Wipe counters`, `Sweep floor`, `Take out trash`, `Clean sink`, `Organize cabinets`],
          Bathroom: [`Scrub toilet`, `Clean mirror`, `Wipe sink`, `Mop floor`, `Restock towels`],
          'Living Room': [`Dust surfaces`, `Vacuum carpet`, `Tidy cushions`, `Wipe TV`, `Organize remotes`],
          Bedroom: [`Make bed`, `Fold clothes`, `Dust nightstand`, `Vacuum floor`, `Organize closet`]
        };
        tasks = fallbacks[room] || [`Wipe surfaces`, `Sweep floor`, `Take trash`, `Clean mirrors`, `Organize items`];
      }

      loading.style.display = 'none';
      renderTasks();
    }

    // === ROOM CLICK ===
    document.querySelectorAll('.room-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentRoom = btn.dataset.room;
        roomTitle.textContent = `${currentRoom} Cleaning`;
        roomSelection.style.display = 'none';
        taskView.style.display = 'block';
        completed.clear();
        updateURL();
        fetchTasks(currentRoom);
      });
    });

    backToRooms.addEventListener('click', () => {
      taskView.style.display = 'none';
      roomSelection.style.display = 'grid';
      updateURL();
    });

    // === LOAD FROM URL ===
    window.addEventListener('load', () => {
      const hash = window.location.hash.slice(1);
      if (hash) {
        const state = decrypt(hash);
        if (state && state.room) {
          currentRoom = state.room;
          completed = new Set(state.done || []);
          roomTitle.textContent = `${currentRoom} Cleaning`;
          roomSelection.style.display = 'none';
          taskView.style.display = 'block';
          fetchTasks(currentRoom);
        }
      }
    });

    // === CRYPTOJS ===
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
    script.onload = () => {};
    document.head.appendChild(script);
  </script>
</body>
</html>
